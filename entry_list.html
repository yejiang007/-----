<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>CMX ä¸­å›½æ‘©æ‰˜è½¦è¶Šé‡é”¦æ ‡èµ› 2025 - å‚èµ›è½¦æ‰‹å‡ºåœºåå•</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background: #0b1120;
            color: #e5e7eb;
        }
        header {
            padding: 16px 24px;
            background: linear-gradient(90deg, #0f172a, #1d4ed8);
            color: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        header h1 {
            margin: 0;
            font-size: 20px;
        }
        #groupSelect {
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid #4b5563;
            background: #020617;
            color: #e5e7eb;
        }
        main {
            padding: 16px;
            display: flex;
            gap: 20px;
        }
        .entry-list-container {
            background: #020617;
            border-radius: 8px;
            padding: 20px;
            flex: 1;
        }
        .sponsors-container {
            background: #020617;
            border-radius: 8px;
            padding: 20px;
            width: 300px;
            min-width: 250px;
        }
        .sponsors-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #e5e7eb;
            text-align: center;
        }
        .sponsors-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        .sponsor-item {
            background: #ffffff;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80px;
            transition: transform 0.2s ease;
        }
        .sponsor-item:hover {
            transform: scale(1.05);
        }
        .sponsor-logo {
            max-width: 100%;
            max-height: 50px;
            object-fit: contain;
            margin-bottom: 8px;
        }
        .sponsor-name {
            font-size: 11px;
            color: #1f2937;
            text-align: center;
            word-break: break-word;
        }
        .entry-list-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #e5e7eb;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        th, td {
            padding: 20px 20px;
            border-bottom: 1px solid #111827;
            text-align: left;
            line-height: 1.4;
        }
        th {
            background: #0f172a;
            color: #9ca3af;
            font-weight: 500;
            font-size: 18px;
        }
        .car-number {
            font-size: 28px;
            font-weight: 700;
            color: #3b82f6;
        }
        .player-name {
            font-size: 22px;
            font-weight: 600;
        }
        .team-name {
            font-size: 18px;
            color: #9ca3af;
        }
        tbody tr {
            transition: background-color 0.2s ease, opacity 0.5s ease;
        }
        tbody tr:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }
        tbody {
            display: block;
            max-height: 640px;
            overflow: hidden;
            transition: opacity 0.5s ease;
        }
        thead tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
        tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
        /* è®¾ç½®åˆ—å®½ä»¥ç¡®ä¿å¯¹é½ */
        th:nth-child(1), td:nth-child(1) {
            width: 15%;
        }
        th:nth-child(2), td:nth-child(2) {
            width: 10%;
        }
        th:nth-child(3), td:nth-child(3) {
            width: 35%;
        }
        th:nth-child(4), td:nth-child(4) {
            width: 40%;
        }
        /* æ·»åŠ æ»šåŠ¨åŠ¨ç”»æ ·å¼ */
        .scroll-container {
            position: relative;
            overflow: hidden;
            height: 640px;
            will-change: transform;
            backface-visibility: hidden;
            perspective: 1000px;
        }
        .scroll-content {
            animation: scroll-up 60s linear infinite;
            transform: translateZ(0);
            backface-visibility: hidden;
        }
        @keyframes scroll-up {
            0% { transform: translateY(0); }
            100% { transform: translateY(-100%); }
        }
        .flag {
            font-size: 16px;
            margin-right: 4px;
        }
        .player-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #3b82f6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .avatar-cell {
            text-align: center;
            padding: 10px;
        }
        .entry-order {
            font-weight: 600;
            color: #3b82f6;
        }
        @media (max-width: 1024px) {
            main {
                flex-direction: column;
            }
            .sponsors-container {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<header>
    <div>
        <h1>CMX ä¸­å›½æ‘©æ‰˜è½¦è¶Šé‡é”¦æ ‡èµ› 2025 - å‚èµ›è½¦æ‰‹å‡ºåœºåå•</h1>
    </div>
    <div>
        <select id="groupSelect"></select>
    </div>
</header>
<main>
    <div class="entry-list-container">
        <div class="entry-list-title" id="groupTitle">å‡ºåœºåå•</div>
        <table>
            <thead>
            <tr>
                <th>è½¦å·</th>
                <th>å¤´åƒ</th>
                <th>è½¦æ‰‹</th>
                <th>è½¦é˜Ÿ</th>
            </tr>
            </thead>
            <tbody id="entryBody">
            </tbody>
        </table>
    </div>
    <div class="sponsors-container">
        <div class="sponsors-title">èµåŠ©å•†</div>
        <div class="sponsors-grid" id="sponsorsGrid"></div>
    </div>
</main>
<script>
    const apiBase = '/api';
    let currentGroupId = null;
    let refreshTimer = null;
    let scrollTimer = null;
    let currentPage = 0;
    let allPlayers = [];
    const PLAYERS_PER_PAGE = 8;

    async function fetchGroups() {
        try {
            const res = await fetch(`${apiBase}/group.php?action=getList`);
            const json = await res.json();
            if (json.code !== 200) {
                console.error('è·å–åˆ†ç»„åˆ—è¡¨å¤±è´¥:', json.msg);
                return;
            }
            const select = document.getElementById('groupSelect');
            select.innerHTML = '';
            json.data.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g.group_id;
                opt.textContent = `${g.group_name} (${g.group_code})`;
                select.appendChild(opt);
            });
            if (json.data.length > 0) {
                // æ£€æŸ¥URLå‚æ•°ä¸­æ˜¯å¦æœ‰æŒ‡å®šçš„åˆ†ç»„ID
                const urlParams = new URLSearchParams(window.location.search);
                const urlGroupId = urlParams.get('group_id');
                
                if (urlGroupId && json.data.find(g => g.group_id == urlGroupId)) {
                    currentGroupId = parseInt(urlGroupId);
                } else {
                    currentGroupId = json.data[0].group_id;
                }
                
                select.value = currentGroupId;
                await fetchEntryList(currentGroupId);
                startAutoRefresh();
            } else {
                document.getElementById('entryBody').innerHTML = '<tr><td colspan="3" style="text-align:center; color:#9ca3af;">æš‚æ— åˆ†ç»„æ•°æ®</td></tr>';
            }
            select.addEventListener('change', async () => {
                currentGroupId = select.value;
                await fetchEntryList(currentGroupId);
                // åˆ‡æ¢åˆ†ç»„æ—¶é‡æ–°å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
                startAutoRefresh();
            });
        } catch (e) {
            console.error('åŠ è½½åˆ†ç»„åˆ—è¡¨å‡ºé”™:', e);
            // ä½¿ç”¨æ¨¡æ‹Ÿåˆ†ç»„æ•°æ®
            const mockGroups = [
                { group_id: 1, group_name: 'ä¸“ä¸šç»„', group_code: 'PRO' },
                { group_id: 2, group_name: 'ä¸šä½™ç»„', group_code: 'AMATEUR' },
                { group_id: 3, group_name: 'é’å°‘å¹´ç»„', group_code: 'YOUTH' }
            ];
            const select = document.getElementById('groupSelect');
            select.innerHTML = '';
            mockGroups.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g.group_id;
                opt.textContent = `${g.group_name} (${g.group_code})`;
                select.appendChild(opt);
            });
            
            currentGroupId = mockGroups[0].group_id;
            select.value = currentGroupId;
            await fetchEntryList(currentGroupId);
            startAutoRefresh();
            
            select.addEventListener('change', async () => {
                currentGroupId = select.value;
                await fetchEntryList(currentGroupId);
                startAutoRefresh();
            });
        }
    }

    async function fetchEntryList(groupId) {
        // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
        const timestamp = new Date().getTime();
        try {
            const res = await fetch(`${apiBase}/entry_list.php?action=getList&group_id=${groupId}&_t=${timestamp}`, {
                cache: 'no-cache',
                headers: {
                    'Cache-Control': 'no-cache'
                }
            });
            const json = await res.json();
            
            if (json.code !== 200) {
                console.error('è·å–å‡ºåœºåå•å¤±è´¥:', json.msg);
                document.getElementById('entryBody').innerHTML = '<tr><td colspan="4" style="text-align:center; color:#9ca3af;">åŠ è½½å¤±è´¥ï¼š' + (json.msg || 'æœªçŸ¥é”™è¯¯') + '</td></tr>';
                return;
            }
            
            const groupSelect = document.getElementById('groupSelect');
            const selectedOption = groupSelect.options[groupSelect.selectedIndex];
            document.getElementById('groupTitle').textContent = `å‡ºåœºåå• Â· ${selectedOption.textContent}`;
            
            // ç¡®ä¿ data æ˜¯æ•°ç»„
            const data = Array.isArray(json.data) ? json.data : [];
            renderEntryList(data);
        } catch (e) {
            console.error('è¯·æ±‚å‡ºé”™:', e);
            // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æµ‹è¯•ï¼ˆåŸºäºæ•°æ®åº“çœŸå®å¤´åƒé“¾æ¥ï¼‰
            const mockData = [
                { player_name: 'å¼ ä¸‰', car_number: '88', nationality: 'ä¸­å›½', team_name: 'CMXé’å°‘å¹´è½¦é˜Ÿ', entry_order: 1, avatar_url: 'https://cdn.cmx.com/avatars/101.jpg' },
                { player_name: 'æå¼º', car_number: '21', nationality: 'ä¸­å›½', team_name: 'å²­å—å°‘å¹´è¶Šé‡é˜Ÿ', entry_order: 2, avatar_url: 'https://cdn.cmx.com/avatars/102.jpg' },
                { player_name: 'Wang Hua', car_number: '66', nationality: 'ä¸­å›½', team_name: 'é£é©°è¶Šé‡è½¦é˜Ÿ', entry_order: 3, avatar_url: 'https://cdn.cmx.com/avatars/103.jpg' },
                { player_name: 'Chen Yu', car_number: '15', nationality: 'ä¸­å›½', team_name: 'æ˜Ÿç«é’è®­è½¦é˜Ÿ', entry_order: 4, avatar_url: 'https://cdn.cmx.com/avatars/104.jpg' },
                { player_name: 'John Doe', car_number: '18', nationality: 'ç¾å›½', team_name: 'International Racing Team', entry_order: 5, avatar_url: 'https://cdn.cmx.com/avatars/201.jpg' },
                { player_name: 'Tanaka', car_number: '28', nationality: 'æ—¥æœ¬', team_name: 'Samurai MX Team', entry_order: 6, avatar_url: 'https://cdn.cmx.com/avatars/202.jpg' },
                { player_name: 'Alex Martin', car_number: '12', nationality: 'æ³•å›½', team_name: 'Euro Speed MX', entry_order: 7, avatar_url: 'https://cdn.cmx.com/avatars/203.jpg' },
                { player_name: 'Carlos Ruiz', car_number: '34', nationality: 'è¥¿ç­ç‰™', team_name: 'Iberia Offroad', entry_order: 8, avatar_url: 'https://cdn.cmx.com/avatars/204.jpg' },
                { player_name: 'Kevin Smith', car_number: '57', nationality: 'è‹±å›½', team_name: 'London MX Club', entry_order: 9, avatar_url: 'https://cdn.cmx.com/avatars/205.jpg' },
                { player_name: 'Matsuda', car_number: '72', nationality: 'æ—¥æœ¬', team_name: 'Samurai MX Team', entry_order: 10, avatar_url: 'https://cdn.cmx.com/avatars/206.jpg' },
                { player_name: 'Luca Rossi', car_number: '39', nationality: 'æ„å¤§åˆ©', team_name: 'Roma Racing', entry_order: 11, avatar_url: 'https://cdn.cmx.com/avatars/207.jpg' },
                { player_name: 'Jack Brown', car_number: '63', nationality: 'æ¾³å¤§åˆ©äºš', team_name: 'Sydney MX Squad', entry_order: 12, avatar_url: 'https://cdn.cmx.com/avatars/208.jpg' }
            ];
            const groupSelect = document.getElementById('groupSelect');
            const selectedOption = groupSelect.options[groupSelect.selectedIndex];
            document.getElementById('groupTitle').textContent = `å‡ºåœºåå• Â· ${selectedOption.textContent}`;
            renderEntryList(mockData);
        }
    }

    function startAutoRefresh() {
        if (refreshTimer) {
            clearInterval(refreshTimer);
        }
        // ç«‹å³åˆ·æ–°ä¸€æ¬¡
        if (currentGroupId) {
            fetchEntryList(currentGroupId);
        }
        fetchSponsors();
        // ç„¶åæ¯3ç§’åˆ·æ–°ä¸€æ¬¡
        refreshTimer = setInterval(() => {
            if (currentGroupId) {
                fetchEntryList(currentGroupId);
            }
            fetchSponsors();
        }, 3000); // æ¯3ç§’åˆ·æ–°ä¸€æ¬¡
    }

    function stopAutoRefresh() {
        if (refreshTimer) {
            clearInterval(refreshTimer);
            refreshTimer = null;
        }
        stopAutoScroll();
    }

    function getFlag(nationality) {
        const map = {
            'ä¸­å›½': 'ğŸ‡¨ğŸ‡³', 'ä¸­å›½å¤§é™†': 'ğŸ‡¨ğŸ‡³', 'é¦™æ¸¯': 'ğŸ‡­ğŸ‡°', 'æ¾³é—¨': 'ğŸ‡²ğŸ‡´', 'å°æ¹¾': 'ğŸ‡¹ğŸ‡¼',
            'ç¾å›½': 'ğŸ‡ºğŸ‡¸', 'æ—¥æœ¬': 'ğŸ‡¯ğŸ‡µ', 'éŸ©å›½': 'ğŸ‡°ğŸ‡·', 'è‹±å›½': 'ğŸ‡¬ğŸ‡§', 'æ³•å›½': 'ğŸ‡«ğŸ‡·',
            'å¾·å›½': 'ğŸ‡©ğŸ‡ª', 'æ„å¤§åˆ©': 'ğŸ‡®ğŸ‡¹', 'è¥¿ç­ç‰™': 'ğŸ‡ªğŸ‡¸', 'æ¾³å¤§åˆ©äºš': 'ğŸ‡¦ğŸ‡º'
        };
        return map[nationality] || 'ğŸ';
    }

    function renderEntryList(list) {
        if (!list || list.length === 0) {
            const tbody = document.getElementById('entryBody');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#9ca3af; font-size:18px;">æš‚æ— å‡ºåœºåå•æ•°æ®</td></tr>';
            allPlayers = [];
            stopAutoScroll();
            return;
        }
        
        // æŒ‰å‡ºåœºé¡ºåºæ’åº
        const sortedList = [...list].sort((a, b) => {
            const orderA = a.entry_order ?? 9999;
            const orderB = b.entry_order ?? 9999;
            return orderA - orderB;
        });
        
        allPlayers = sortedList;
        
        // å¦‚æœæ€»æ•°ä¸è¶…è¿‡8æ¡ï¼Œç›´æ¥æ˜¾ç¤ºï¼Œä¸æ»šåŠ¨
        if (allPlayers.length <= PLAYERS_PER_PAGE) {
            renderStaticList();
            stopAutoScroll();
            return;
        }
        
        // è¶…è¿‡8æ¡æ—¶ï¼Œä½¿ç”¨æ— é™å¾ªç¯æ»šåŠ¨
        renderContinuousList();
        startAutoScroll();
    }

    function renderStaticList() {
        const tbody = document.getElementById('entryBody');
        tbody.innerHTML = '';
        
        allPlayers.forEach(row => {
            const tr = document.createElement('tr');
            const flag = getFlag(row.nationality || '');
            const avatarUrl = row.avatar_url || '/img/img.png';
            tr.innerHTML = `
                 <td><span class="car-number">${row.car_number || '-'}</span></td>
                 <td class="avatar-cell"><img src="${avatarUrl}" alt="${row.player_name || ''}" class="player-avatar" loading="lazy" decoding="async" width="60" height="60" onerror="this.src='/img/img.png'"></td>
                 <td><span class="flag">${flag}</span><span class="player-name">${row.player_name || '-'}</span></td>
                 <td><span class="team-name">${row.team_name || '-'}</span></td>
             `;
            tbody.appendChild(tr);
        });
    }

    function renderContinuousList() {
        const tbody = document.getElementById('entryBody');
        tbody.innerHTML = '';
        
        // åˆ›å»ºæ»šåŠ¨å®¹å™¨
        const scrollContainer = document.createElement('div');
        scrollContainer.className = 'scroll-container';
        
        // åˆ›å»ºæ»šåŠ¨å†…å®¹
        const scrollContent = document.createElement('div');
        scrollContent.className = 'scroll-content';
        
        // ä¸ºäº†æ— ç¼å¾ªç¯ï¼Œæˆ‘ä»¬éœ€è¦å¤åˆ¶å†…å®¹ä¸‰æ¬¡ï¼Œç¡®ä¿å¹³æ»‘è¿‡æ¸¡
        for (let i = 0; i < 3; i++) {
            allPlayers.forEach(row => {
                const tr = document.createElement('tr');
                const flag = getFlag(row.nationality || '');
                const avatarUrl = row.avatar_url || '/img/img.png';
                tr.innerHTML = `
                    <td><span class="car-number">${row.car_number || '-'}</span></td>
                    <td class="avatar-cell"><img src="${avatarUrl}" alt="${row.player_name || ''}" class="player-avatar" loading="lazy" decoding="async" width="60" height="60" onerror="this.src='/img/img.png'"></td>
                    <td><span class="flag">${flag}</span><span class="player-name">${row.player_name || '-'}</span></td>
                    <td><span class="team-name">${row.team_name || '-'}</span></td>
                `;
                scrollContent.appendChild(tr);
            });
        }
        
        scrollContainer.appendChild(scrollContent);
        tbody.appendChild(scrollContainer);
    }

    function startAutoScroll() {
        if (scrollTimer) {
            clearInterval(scrollTimer);
        }
        
        // å¦‚æœæ€»æ•°ä¸è¶…è¿‡8æ¡ï¼Œä¸æ»šåŠ¨
        if (allPlayers.length <= PLAYERS_PER_PAGE) {
            return;
        }
        
        // ä½¿ç”¨CSSåŠ¨ç”»å®ç°æ— é™å¾ªç¯æ»šåŠ¨
        // åŠ¨ç”»å·²ç»åœ¨CSSä¸­å®šä¹‰ï¼Œè¿™é‡Œä¸éœ€è¦é¢å¤–çš„JavaScriptå®šæ—¶å™¨
    }

    function stopAutoScroll() {
        if (scrollTimer) {
            clearInterval(scrollTimer);
            scrollTimer = null;
        }
    }

    async function fetchSponsors() {
        try {
            const res = await fetch(`${apiBase}/sponsor.php?action=getList`);
            const json = await res.json();
            if (json.code === 200 && Array.isArray(json.data)) {
                renderSponsors(json.data);
            }
        } catch (e) {
            console.error('åŠ è½½èµåŠ©å•†å¤±è´¥:', e);
            // ä½¿ç”¨æ¨¡æ‹ŸèµåŠ©å•†æ•°æ®
            const mockSponsors = [
                { sponsor_name: 'æé€Ÿè½®èƒ', logo_url: 'https://via.placeholder.com/120x50/3b82f6/ffffff?text=æé€Ÿè½®èƒ' },
                { sponsor_name: 'åŠ¨åŠ›æœºæ²¹', logo_url: 'https://via.placeholder.com/120x50/ef4444/ffffff?text=åŠ¨åŠ›æœºæ²¹' },
                { sponsor_name: 'èµ›è½¦è£…å¤‡', logo_url: 'https://via.placeholder.com/120x50/10b981/ffffff?text=èµ›è½¦è£…å¤‡' },
                { sponsor_name: 'ä¸“ä¸šç»´ä¿®', logo_url: 'https://via.placeholder.com/120x50/f59e0b/ffffff?text=ä¸“ä¸šç»´ä¿®' },
                { sponsor_name: 'å®‰å…¨å¤´ç›”', logo_url: 'https://via.placeholder.com/120x50/8b5cf6/ffffff?text=å®‰å…¨å¤´ç›”' },
                { sponsor_name: 'é«˜æ€§èƒ½é…ä»¶', logo_url: 'https://via.placeholder.com/120x50/06b6d4/ffffff?text=é«˜æ€§èƒ½é…ä»¶' }
            ];
            renderSponsors(mockSponsors);
        }
    }

    function renderSponsors(list) {
        const container = document.getElementById('sponsorsGrid');
        container.innerHTML = '';
        
        if (!list || list.length === 0) {
            container.innerHTML = '<div style="grid-column: 1/-1; text-align:center; color:#9ca3af; padding:20px;">æš‚æ— èµåŠ©å•†</div>';
            return;
        }
        
        list.forEach(sponsor => {
            const div = document.createElement('div');
            div.className = 'sponsor-item';
            div.innerHTML = `
                <img src="${sponsor.logo_url}" alt="${sponsor.sponsor_name}" class="sponsor-logo" onerror="this.style.display='none'">
                <div class="sponsor-name">${sponsor.sponsor_name || ''}</div>
            `;
            container.appendChild(div);
        });
    }

    // é¡µé¢å¯è§æ€§æ£€æµ‹ï¼šå½“é¡µé¢é‡æ–°å¯è§æ—¶ç«‹å³åˆ·æ–°æ•°æ®
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden && currentGroupId) {
            fetchEntryList(currentGroupId);
            fetchSponsors();
            startAutoRefresh();
        } else {
            stopAutoRefresh();
        }
    });

    // çª—å£è·å¾—ç„¦ç‚¹æ—¶åˆ·æ–°æ•°æ®
    window.addEventListener('focus', () => {
        if (currentGroupId) {
            fetchEntryList(currentGroupId);
            fetchSponsors();
            startAutoRefresh();
        }
    });

    // çª—å£å¤±å»ç„¦ç‚¹æ—¶åœæ­¢è‡ªåŠ¨åˆ·æ–°ï¼ˆèŠ‚çœèµ„æºï¼‰
    window.addEventListener('blur', () => {
        stopAutoRefresh();
    });

    fetchGroups();
    fetchSponsors();
</script>
</body>
</html>

